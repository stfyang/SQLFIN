<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>點餐</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma/css/bulma.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="jump.js" defer></script>
  <script src="order.js" defer></script>
</head>
<body class="section">
<div class="container">
  <h1 class="title">新增訂單</h1>

  <div class="field is-grouped">
    <div class="control">
      <div class="select">
        <select id="dishSelect"></select>
      </div>
    </div>
    <div class="control">
      <input class="input" type="number" id="dishQty" min="1" value="1">
    </div>
    <div class="control">
      <button class="button is-primary" onclick="addToCart()">➕ 加入</button>
    </div>
  </div>

  <h2 class="subtitle">🧾 已選餐點</h2>
  <table class="table is-fullwidth" id="cartTable">
    <thead>
      <tr>
        <th>菜品</th>
        <th>數量</th>
        <th>單價</th>
        <th>小計</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="cartBody"></tbody>
  </table>

  <div class="field">
    <label class="label">總價</label>
    <input class="input" id="total" readonly>
  </div>

  <button class="button is-success" onclick="submitOrder()">✅ 新增訂單</button>
  <button onclick="location.href='order_query.php'">查詢訂單</button>

</div>

<script>
let menu = {};
let cart = {};

async function loadMenu() {
  const res = await axios.get('get_order.php');
  const select = document.getElementById('dishSelect');
  res.data.forEach(d => {
    menu[d.菜品名] = d.單價;
    const opt = document.createElement('option');
    opt.value = d.菜品名;
    opt.text = `${d.菜品名}（${d.單價}元）`;
    select.appendChild(opt);
  });
}

function addToCart() {
  const name = document.getElementById('dishSelect').value;
  const qty = parseInt(document.getElementById('dishQty').value);
  if (!name || qty < 1) return;

  if (cart[name]) {
    cart[name] += qty;
  } else {
    cart[name] = qty;
  }

  renderCart();
}

function removeFromCart(name) {
  delete cart[name];
  renderCart();
}

function renderCart() {
  const tbody = document.getElementById('cartBody');
  tbody.innerHTML = '';
  let total = 0;

  for (const [name, qty] of Object.entries(cart)) {
    const price = menu[name];
    const subtotal = price * qty;
    total += subtotal;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${name}</td>
      <td>${qty}</td>
      <td>${price}</td>
      <td>${subtotal}</td>
      <td><button class="button is-small is-danger" onclick="removeFromCart('${name}')">刪除</button></td>
    `;
    tbody.appendChild(row);
  }

  document.getElementById('total').value = total;
}

async function submitOrder() {
  if (Object.keys(cart).length === 0) {
    alert('請先加入餐點');
    return;
  }

  try {
    const res = await axios.post('add_order.php', { dishes: cart });
    alert(res.data.message);
    location.reload();
  } catch (err) {
    alert('新增失敗');
    console.error(err);
  }
}

loadMenu();
</script>
<a href="index.html">首頁</a>
<script>
document.getElementById('orderForm').addEventListener('submit', function(e) {
  e.preventDefault();

  // 從表單收集所有餐點的數量
  const form = e.target;
  const formData = new FormData(form);
  const dishes = {};

  formData.forEach((value, key) => {
    const qty = parseInt(value);
    if (qty > 0) {
      dishes[key] = qty;
    }
  });

  // 若未選擇任何餐點
  if (Object.keys(dishes).length === 0) {
    document.getElementById('message').innerHTML = '<p style="color:red;">請選擇至少一項餐點。</p>';
    return;
  }

  // 發送到 PHP
  fetch('新增訂單.php', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ dishes })
  })
  .then(response => response.json())
  .then(data => {
    const msgBox = document.getElementById('message');
    if (data.error) {
      msgBox.innerHTML = `<p style="color:red;">${data.error}</p>`;
      if (data.details && Array.isArray(data.details)) {
        const list = data.details.map(item => `<li>${item}</li>`).join('');
        msgBox.innerHTML += `<ul style="color:red;">${list}</ul>`;
      }
    } else {
      msgBox.innerHTML = `<p style="color:green;">${data.message}</p>`;
      form.reset(); // 清空表單
    }
  })
  .catch(err => {
    document.getElementById('message').innerHTML = '<p style="color:red;">系統錯誤，請稍後再試。</p>';
    console.error(err);
  });
});
</script>

</body>
</html>
