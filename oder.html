<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é»é¤</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma/css/bulma.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="jump.js" defer></script>
  <script src="order.js" defer></script>
</head>
<body class="section">
<div class="container">
  <h1 class="title">æ–°å¢è¨‚å–®</h1>

  <div class="field is-grouped">
    <div class="control">
      <div class="select">
        <select id="dishSelect"></select>
      </div>
    </div>
    <div class="control">
      <input class="input" type="number" id="dishQty" min="1" value="1">
    </div>
    <div class="control">
      <button class="button is-primary" onclick="addToCart()">â• åŠ å…¥</button>
    </div>
  </div>

  <h2 class="subtitle">ğŸ§¾ å·²é¸é¤é»</h2>
  <table class="table is-fullwidth" id="cartTable">
    <thead>
      <tr>
        <th>èœå“</th>
        <th>æ•¸é‡</th>
        <th>å–®åƒ¹</th>
        <th>å°è¨ˆ</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="cartBody"></tbody>
  </table>

  <div class="field">
    <label class="label">ç¸½åƒ¹</label>
    <input class="input" id="total" readonly>
  </div>

  <button class="button is-success" onclick="submitOrder()">âœ… æ–°å¢è¨‚å–®</button>
  <button onclick="location.href='order_query.php'">æŸ¥è©¢è¨‚å–®</button>

</div>

<script>
let menu = {};
let cart = {};

async function loadMenu() {
  const res = await axios.get('get_order.php');
  const select = document.getElementById('dishSelect');
  res.data.forEach(d => {
    menu[d.èœå“å] = d.å–®åƒ¹;
    const opt = document.createElement('option');
    opt.value = d.èœå“å;
    opt.text = `${d.èœå“å}ï¼ˆ${d.å–®åƒ¹}å…ƒï¼‰`;
    select.appendChild(opt);
  });
}

function addToCart() {
  const name = document.getElementById('dishSelect').value;
  const qty = parseInt(document.getElementById('dishQty').value);
  if (!name || qty < 1) return;

  if (cart[name]) {
    cart[name] += qty;
  } else {
    cart[name] = qty;
  }

  renderCart();
}

function removeFromCart(name) {
  delete cart[name];
  renderCart();
}

function renderCart() {
  const tbody = document.getElementById('cartBody');
  tbody.innerHTML = '';
  let total = 0;

  for (const [name, qty] of Object.entries(cart)) {
    const price = menu[name];
    const subtotal = price * qty;
    total += subtotal;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${name}</td>
      <td>${qty}</td>
      <td>${price}</td>
      <td>${subtotal}</td>
      <td><button class="button is-small is-danger" onclick="removeFromCart('${name}')">åˆªé™¤</button></td>
    `;
    tbody.appendChild(row);
  }

  document.getElementById('total').value = total;
}

async function submitOrder() {
  if (Object.keys(cart).length === 0) {
    alert('è«‹å…ˆåŠ å…¥é¤é»');
    return;
  }

  try {
    const res = await axios.post('add_order.php', { dishes: cart });
    alert(res.data.message);
    location.reload();
  } catch (err) {
    alert('æ–°å¢å¤±æ•—');
    console.error(err);
  }
}

loadMenu();
</script>
<a href="index.html">é¦–é </a>
<script>
document.getElementById('orderForm').addEventListener('submit', function(e) {
  e.preventDefault();

  // å¾è¡¨å–®æ”¶é›†æ‰€æœ‰é¤é»çš„æ•¸é‡
  const form = e.target;
  const formData = new FormData(form);
  const dishes = {};

  formData.forEach((value, key) => {
    const qty = parseInt(value);
    if (qty > 0) {
      dishes[key] = qty;
    }
  });

  // è‹¥æœªé¸æ“‡ä»»ä½•é¤é»
  if (Object.keys(dishes).length === 0) {
    document.getElementById('message').innerHTML = '<p style="color:red;">è«‹é¸æ“‡è‡³å°‘ä¸€é …é¤é»ã€‚</p>';
    return;
  }

  // ç™¼é€åˆ° PHP
  fetch('æ–°å¢è¨‚å–®.php', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ dishes })
  })
  .then(response => response.json())
  .then(data => {
    const msgBox = document.getElementById('message');
    if (data.error) {
      msgBox.innerHTML = `<p style="color:red;">${data.error}</p>`;
      if (data.details && Array.isArray(data.details)) {
        const list = data.details.map(item => `<li>${item}</li>`).join('');
        msgBox.innerHTML += `<ul style="color:red;">${list}</ul>`;
      }
    } else {
      msgBox.innerHTML = `<p style="color:green;">${data.message}</p>`;
      form.reset(); // æ¸…ç©ºè¡¨å–®
    }
  })
  .catch(err => {
    document.getElementById('message').innerHTML = '<p style="color:red;">ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
    console.error(err);
  });
});
</script>

</body>
</html>
